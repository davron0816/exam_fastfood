const translations = {
    en: {
        siteTitle: "Tasty Fast Food",
        navHome: "Home",
        navMenu: "Menu",
        navContact: "Contact",
        slider1Title: "Pepperoni Pizza",
        slider1Text: "Only 99,000 so‘m! Order now!",
        slider2Title: "Cheeseburger Delight",
        slider2Text: "Only 45,000 so‘m! Grab yours!",
        slider3Title: "Refreshing Cola",
        slider3Text: "Only 12,000 so‘m!",
        sliderOrder: "Order Now",
        menuTitle: "Our Menu",
        filterAll: "All",
        filterPizza: "Pizza",
        filterBurger: "Burger",
        filterLavash: "Lavash",
        filterDrink: "Drink",
        filterDessert: "Dessert",
        filterTwister: "Twister",
        priceAll: "All Prices",
        priceLow: "Under 100,000 so‘m",
        priceHigh: "Over 100,000 so‘m",
        contactTitle: "Contact Us",
        contactPhone: "Phone: +998 95 772 70 37",
        contactEmail: "Email: info@fastfooddelight.uz",
        cartTitle: "Your Cart",
        cartTotal: "Total: 0 so‘m",
        saveOrder: "Save Order",
        close: "Close",
        checkout: "Checkout",
        deliveryTitle: "Delivery Details",
        deliveryName: "Full Name",
        deliveryPhone: "Phone",
        deliveryAddress: "Address",
        deliveryTime: "Delivery Time",
        timeAsap: "As soon as possible",
        time30min: "In 30 minutes",
        time1hour: "In 1 hour",
        cancel: "Cancel",
        proceedToPayment: "Proceed to Payment",
        paymentTitle: "Payment Details",
        cardNumber: "Card Number",
        expiryDate: "Expiry Date",
        cvv: "CVV",
        payNow: "Pay Now",
        savedOrdersTitle: "Saved Orders",
        order: "Order",
        cartEmpty: "Your cart is empty!",
        orderSaved: "Order saved!",
        orderSubmitted: "Order submitted successfully!",
        addToCart: "Add to Cart",
        remove: "Remove",
        viewSavedOrders: "View Saved Orders",
        paymentSuccess: "Payment successful!"
    },
    uz: {
        siteTitle: "Tezkor Fast Food",
        navHome: "Bosh sahifa",
        navMenu: "Menyu",
        navContact: "Aloqa",
        slider1Title: "Pepperoni Pizza",
        slider1Text: "Faqat 99,000 so‘m! Hozir buyurtma bering!",
        slider2Title: "Cheeseburger Sevinchi",
        slider2Text: "Faqat 45,000 so‘m! Oling!",
        slider3Title: "Tetiklantiruvchi Kola",
        slider3Text: "Faqat 12,000 so‘m!",
        sliderOrder: "Hozir buyurtma",
        menuTitle: "Bizning Menyu",
        filterAll: "Hammasi",
        filterPizza: "Pizza",
        filterBurger: "Burger",
        filterLavash: "Lavash",
        filterDrink: "Ichimlik",
        filterDessert: "Shirinlik",
        filterTwister: "Tvister",
        priceAll: "Barcha narxlar",
        priceLow: "100,000 so‘mdan past",
        priceHigh: "100,000 so‘mdan yuqori",
        contactTitle: "Biz bilan bog‘laning",
        contactPhone: "Telefon: +998 95 772 70 37",
        contactEmail: "Email: info@fastfooddelight.uz",
        cartTitle: "Sizning Savatchangiz",
        cartTotal: "Jami: 0 so‘m",
        saveOrder: "Buyurtmani saqlash",
        close: "Yopish",
        checkout: "Buyurtma berish",
        deliveryTitle: "Yetkazib berish ma’lumotlari",
        deliveryName: "To‘liq ism",
        deliveryPhone: "Telefon",
        deliveryAddress: "Manzil",
        deliveryTime: "Yetkazib berish vaqti",
        timeAsap: "Iloji boricha tez",
        time30min: "30 daqiqada",
        time1hour: "1 soatda",
        cancel: "Bekor qilish",
        proceedToPayment: "To‘lovga o‘tish",
        paymentTitle: "To‘lov ma’lumotlari",
        cardNumber: "Karta raqami",
        expiryDate: "Amal qilish muddati",
        cvv: "CVV",
        payNow: "Hozir to‘lash",
        savedOrdersTitle: "Saqlangan Buyurtmalar",
        order: "Buyurtma",
        cartEmpty: "Savatchangiz bo‘sh!",
        orderSaved: "Buyurtma saqlandi!",
        orderSubmitted: "Buyurtma muvaffaqiyatli yuborildi!",
        addToCart: "Savatchaga qo‘shish",
        remove: "O‘chirish",
        viewSavedOrders: "Saqlangan buyurtmalarni ko‘rish",
        paymentSuccess: "To‘lov muvaffaqiyatli amalga oshirildi!"
    },
    ru: {
        siteTitle: "Tezkor Fast Food",
        navHome: "Главная",
        navMenu: "Меню",
        navContact: "Контакты",
        slider1Title: "Пицца Пепперони",
        slider1Text: "Всего 99,000 сум! Закажите сейчас!",
        slider2Title: "Чизбургер Делайт",
        slider2Text: "Всего 45,000 сум! Берите свой!",
        slider3Title: "Освежающая Кола",
        slider3Text: "Всего 12,000 сум!",
        sliderOrder: "Заказать сейчас",
        menuTitle: "Наше Меню",
        filterAll: "Все",
        filterPizza: "Пицца",
        filterBurger: "Бургер",
        filterLavash: "Лаваш",
        filterDrink: "Напиток",
        filterDessert: "Десерт",
        filterTwister: "Твистер",
        priceAll: "Все цены",
        priceLow: "Менее 100,000 сум",
        priceHigh: "Более 100,000 сум",
        contactTitle: "Свяжитесь с нами",
        contactPhone: "Телефон: +998 95 772 70 37",
        contactEmail: "Email: info@fastfooddelight.uz",
        cartTitle: "Ваша Корзина",
        cartTotal: "Итого: 0 сум",
        saveOrder: "Сохранить заказ",
        close: "Закрыть",
        checkout: "Оформить заказ",
        deliveryTitle: "Детали доставки",
        deliveryName: "Полное имя",
        deliveryPhone: "Телефон",
        deliveryAddress: "Адрес",
        deliveryTime: "Время доставки",
        timeAsap: "Как можно скорее",
        time30min: "Через 30 минут",
        time1hour: "Через 1 час",
        cancel: "Отмена",
        proceedToPayment: "Перейти к оплате",
        paymentTitle: "Детали оплаты",
        cardNumber: "Номер карты",
        expiryDate: "Срок действия",
        cvv: "CVV",
        payNow: "Оплатить сейчас",
        savedOrdersTitle: "Сохраненные заказы",
        order: "Заказ",
        cartEmpty: "Ваша корзина пуста!",
        orderSaved: "Заказ сохранен!",
        orderSubmitted: "Заказ успешно отправлен!",
        addToCart: "Добавить в корзину",
        remove: "Удалить",
        viewSavedOrders: "Просмотреть сохраненные заказы",
        paymentSuccess: "Оплата успешно завершена!"
    }
};

const menuItems = [
    { id: 1, name: 'Pepperoni Pizza', category: 'pizza', price: 120000, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F03bf0000-6bec-ac1f-1835-08dd5243903e.jpg&w=1920&q=75' },
    { id: 2, name: 'Cheeseburger', category: 'burger', price: 45000, image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80' },
    { id: 3, name: 'Margarita Pizza', category: 'pizza', price: 45000, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F601282db-7274-43e4-ac74-e8987d53dd6e.jpg&w=1920&q=100'},
    { id: 4, name: 'Pizza', category: 'pizza', price: 120000, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F49146c0e-fe2f-424a-a5b0-c167af6da6a1.jpg&w=1920&q=100' },
    { id: 23, name: 'BBQ Chicken Pizza', category: 'pizza', price: 70000, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F405e4be1-3493-49d2-ab92-4eb256200ac5.jpg&w=1920&q=100' },
    { id: 5, name: 'Mol Go‘shtli Lavash', category: 'lavash', price: 40000, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/968187d2f058109eed884ccf93c9e2f0.PNG' },
    { id: 6, name: 'Tovuq Donerli Lavash', category: 'lavash', price: 40000, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/c07742eb82b90e575fb2d93d26d865ff.PNG' },
    { id: 7, name: 'Ajika Lavash', category: 'lavash', price: 35000, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/819d286dde475801c8e8045ac0d13d76.PNG' },
    { id: 8, name: 'Koftali Lavash', category: 'lavash', price: 81774, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/b8e80d22ab3ccd7725cbc95e1d8c3785.PNG' }, // 6.49 USD * 12600 = 81774 so‘m
    { id: 9, name: 'Sabzavotli Lavash', category: 'lavash', price: 56574, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/133816f9dc759e7bb145df2e8f3f1325.PNG' }, // 4.49 USD
    { id: 10, name: 'Falafelli Lavash', category: 'lavash', price: 69174, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/c07742eb82b90e575fb2d93d26d865ff.PNG' }, // 5.49 USD // 6.29 USD
    { id: 12, name: 'Hotdog', category: 'hotdog', price: 18000, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/f61f531ec4ba6f9e8e244b5578a48dfe.PNG' }, // 6.79 USD
    { id: 13, name: 'Lavash', category: 'lavash', price: 91854, image: 'https://kfc.com.uz/admin/files/4481.jpg' }, // 7.29 USD
    { id: 14, name: 'Tvister', category: 'lavash', price: 113274, image: 'https://kfc.com.uz/admin/files/5555.jpg' }, // 8.99 USD
    { id: 15, name: 'Klassik Gamburger', category: 'burger', price: 100674, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/images/items/0aa69d24179221bca4bfc290d37b3919.PNG' }, // 7.99 USD
    { id: 16, name: 'Donar', price: 106974, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/001aec689b5d710d1be3b0c00ecc0db4.PNG' }, // 8.49 USD
    { id: 17, name: 'Barbekyu Gamburger', category: 'burger', price: 117054, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/images/items/a5215bad61bad759718d5582dbc15e1e.PNG' }, // 9.29 USD
    { id: 18, name: 'Hotdog', category: 'burger', price: 15500, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/3a02ff18270287a094e3bab6f23f778a.PNG' }, // 7.49 USD
    { id: 19, name: 'Gamburger', category: 'burger', price: 113274, image: 'https://kfc.com.uz/admin/files/4474.jpg' }, // 8.99 USD
    { id: 20, name: 'Vegan Gamburger', category: 'burger', price: 88074, image: 'https://kfc.com.uz/admin/files/4473.jpg' }, // 6.99 USD
    { id: 21, name: 'Tovuq Gamburger', category: 'burger', price: 91854, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/images/items/a791280e692f6f58be30dee1db9ebbbf.PNG' }, // 7.29 USD
    { id: 22, name: 'Shourma', category: 'burger', price: 45000, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/1b466bda9de0ae715c867eedf055d24c.PNG' }, // 10.99 USD
    { id: 25, name: 'Coca-Cola', category: 'drink', price: 12000, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F83bf6e19-b204-4351-84ce-ab7376b40827.jpg&w=1920&q=100' },
    { id: 26, name: 'Pepsi', category: 'drink', price: 37674, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/2dd9b8b570d5136335ed04e6c5af74fe.PNG' }, // 2.99 USD
    { id: 28, name: 'Sprite', category: 'drink', price: 37674, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F6569e14a-4bf5-4382-96a7-ebe1013ea8b3.jpg&w=1920&q=100' }, // 2.99 USD
    { id: 30, name: 'Ananas soki', category: 'drink', price: 43974, image: 'https://16a9564f-f8ec-42ba-a998-3027aa809e50.selstorage.ru/evos/72611/30864/images/items/a9bdf761d65362cef151f7d309a57021.PNG' }, // 3.49 USD
    { id: 31, name: 'Cheesecake', category: 'dessert', price: 75474, image: 'https://www.jocooks.com/wp-content/uploads/2018/11/cheesecake-1-22-500x500.jpg' }, // 5.99 USD
    { id: 32, name: 'Chocolate cake', category: 'dessert', price: 81774, image: 'https://www.allrecipes.com/thmb/zb8muWE6CQ5XjclY_LQ2i-QwxN0=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/17981-one-bowl-chocolate-cake-iii-DDMFS-beauty-4x3-d2e182087e4b42a3a281a0a355ea60d1.jpg' }, // 6.49 USD
    { id: 33, name: 'Tiramisu', category: 'dessert', price: 88074, image: 'https://bakingamoment.com/wp-content/uploads/2023/10/IMG_3431-tiramisu-cake.jpg' }, // 6.99 USD
    { id: 34, name: 'Rollar', category: 'dessert', price: 62874, image: 'https://bellissimo.uz/_next/image?url=https%3A%2F%2Fio.bellissimo.uz%2Fimages%2F3a9e1b1a-9327-4c6c-959f-a2981565baaa.jpg&w=1920&q=100' }, // 4.99 USD
    { id: 35, name: 'Baklava', category: 'dessert', price: 69174, image: 'https://ir.ozone.ru/s3/multimedia-s/wc1000/6714845236.jpg' }, // 5.49 USD
    { id: 36, name: 'Paxlava', category: 'dessert', price: 66654, image: 'https://ir.ozone.ru/s3/multimedia-3/wc1000/6819693123.jpg' }, // 5.29 USD
    { id: 37, name: 'Napalyon', category: 'dessert', price: 62874, image: 'https://www.chefmarket.ru/blog/wp-content/uploads/2020/10/layered-cake--2000x1200.jpg' }, // 4.99 USD
    { id: 38, name: 'Twister', category: 'twister', price: 50274, image: 'https://sawepecomcdn.blob.core.windows.net/kfc-web-ordering/KFC_HUN/22_Wraps/440x440/kfc_hun_twister_440x440.jpg' } // 3.99 USD
];

let cart = JSON.parse(localStorage.getItem('cart')) || [];
let savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || [];
let currentOrder = null;

const map = L.map('map').setView([41.2995, 69.2401], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);
const markerLayer = L.layerGroup().addTo(map);
L.marker([41.2995, 69.2401]).addTo(markerLayer)
    .bindPopup('Fast Food Delight')
    .openPopup();

function setLanguage(lang) {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = translations[lang][key];
    });
    document.querySelectorAll('#priceFilter option').forEach((option, index) => {
        const keys = ['priceAll', 'priceLow', 'priceHigh'];
        option.textContent = translations[lang][keys[index]];
    });
    document.querySelectorAll('#deliveryTime option').forEach((option, index) => {
        const keys = ['timeAsap', 'time30min', 'time1hour'];
        option.textContent = translations[lang][keys[index]];
    });
    updateCart();
    localStorage.setItem('language', lang);
}

document.getElementById('languageSelect').addEventListener('change', (e) => {
    setLanguage(e.target.value);
});

function displayMenu(category = 'all', priceFilter = 'all') {
    const menuDiv = document.getElementById('menuItems');
    menuDiv.innerHTML = '';
    menuItems.forEach(item => {
        const matchesCategory = category === 'all' || item.category === category;
        const matchesPrice = priceFilter === 'all' ||
            (priceFilter === 'low' && item.price < 100000) ||
            (priceFilter === 'high' && item.price >= 100000);
        if (matchesCategory && matchesPrice) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-md menu-card';
            card.innerHTML = `
                <img src="${item.image}" alt="${item.name}" class="w-full z-0 h-40 object-cover rounded-md mb-4">
                <h3 class="text-lg font-bold">${item.name}</h3>
                <p class="text-gray-600">${item.price.toLocaleString('uz-UZ')} so‘m</p>
                <button onclick="addToCart(${item.id})" class="mt-2 w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors gradient-btn" data-i18n="addToCart">Add to Cart</button>
            `;
            menuDiv.appendChild(card);
        }
    });
    setLanguage(document.getElementById('languageSelect').value);
}

function addToCart(itemId) {
    const item = menuItems.find(i => i.id === itemId);
    const existingItem = cart.find(cartItem => cartItem.id === itemId);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        cart.push({ ...item, quantity: 1 });
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
}

function updateCart() {
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    cartItems.innerHTML = '';
    let total = 0;
    cart.forEach((item, index) => {
        const itemTotal = item.price * (item.quantity || 1);
        total += itemTotal;
        const li = document.createElement('li');
        li.className = 'flex justify-between';
        li.innerHTML = `
            <span>${item.name} (x${item.quantity || 1})</span>
            <div>
                <span>${itemTotal.toLocaleString('uz-UZ')} so‘m</span>
                <button onclick="removeFromCart(${index})" class="ml-2 text-red-500 hover:text-red-700" data-i18n="remove">Remove</button>
            </div>
        `;
        cartItems.appendChild(li);
    });
    cartCount.textContent = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    cartCount.classList.toggle('hidden', cart.length === 0);
    const lang = document.getElementById('languageSelect').value;
    cartTotal.textContent = `${translations[lang].cartTotal.split(':')[0]}: ${total.toLocaleString('uz-UZ')} so‘m`;
}

function removeFromCart(index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
}

function toggleCart() {
    const cartModal = document.getElementById('cartModal');
    cartModal.classList.toggle('hidden');
    cartModal.classList.toggle('opacity-0');
    cartModal.classList.toggle('opacity-100');
    cartModal.classList.toggle('transform');
    cartModal.classList.toggle('translate-y-4');
    document.getElementById('deliveryModal').classList.add('hidden');
    document.getElementById('paymentModal').classList.add('hidden');
}

function saveOrder() {
    if (cart.length === 0) {
        const lang = document.getElementById('languageSelect').value;
        alert(translations[lang].cartEmpty);
        return;
    }
    savedOrders.push([...cart]);
    localStorage.setItem('savedOrders', JSON.stringify(savedOrders));
    const lang = document.getElementById('languageSelect').value;
    alert(translations[lang].orderSaved);
    updateSavedOrders();
}

function toggleSavedOrders() {
    const savedOrdersModal = document.getElementById('savedOrdersModal');
    savedOrdersModal.classList.toggle('hidden');
    savedOrdersModal.classList.toggle('opacity-0');
    savedOrdersModal.classList.toggle('opacity-100');
    savedOrdersModal.classList.toggle('transform');
    savedOrdersModal.classList.toggle('translate-y-4');
}

function updateSavedOrders() {
    const savedOrdersList = document.getElementById('savedOrdersList');
    savedOrdersList.innerHTML = '';
    const lang = document.getElementById('languageSelect').value;
    savedOrders.forEach((order, index) => {
        const li = document.createElement('li');
        li.className = 'border-b py-2';
        li.innerHTML = `
            <p>${translations[lang].order} ${index + 1}: ${order.map(item => item.name).join(', ')}</p>
            <p>${translations[lang].cartTotal.split(':')[0]}: ${order.reduce((sum, item) => sum + item.price * (item.quantity || 1), 0).toLocaleString('uz-UZ')} so‘m</p>
        `;
        savedOrdersList.appendChild(li);
    });
}

function showDeliveryForm() {
    const lang = document.getElementById('languageSelect').value;
    const cartEmptyMessage = document.getElementById('cartEmptyMessage');
    if (cart.length === 0) {
        cartEmptyMessage.classList.remove('hidden');
        return;
    }
    cartEmptyMessage.classList.add('hidden');
    document.getElementById('cartModal').classList.add('hidden');
    document.getElementById('deliveryModal').classList.remove('hidden');
}

function toggleDelivery() {
    const deliveryModal = document.getElementById('deliveryModal');
    deliveryModal.classList.toggle('hidden');
    deliveryModal.classList.toggle('opacity-0');
    deliveryModal.classList.toggle('opacity-100');
    deliveryModal.classList.toggle('transform');
    deliveryModal.classList.toggle('translate-y-4');
}

function showPaymentForm() {
    document.getElementById('deliveryModal').classList.add('hidden');
    document.getElementById('paymentModal').classList.remove('hidden');
}

function togglePayment() {
    const paymentModal = document.getElementById('paymentModal');
    paymentModal.classList.toggle('hidden');
    paymentModal.classList.toggle('opacity-0');
    paymentModal.classList.toggle('opacity-100');
    paymentModal.classList.toggle('transform');
    paymentModal.classList.toggle('translate-y-4');
}

document.getElementById('address').addEventListener('input', (e) => {
    const address = e.target.value.trim().toLowerCase();
    const deliveryFee = address.includes('toshkent') ? 20000 : 50000;
    const lang = document.getElementById('languageSelect').value;
    document.getElementById('deliveryFeeDisplay').textContent = `${translations[lang].deliveryFee || 'Delivery Fee'}: ${deliveryFee.toLocaleString('uz-UZ')} so‘m`;
});

document.getElementById('deliveryForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const address = document.getElementById('address').value.trim();
    const deliveryFee = address.toLowerCase().includes('toshkent') ? 20000 : 50000;
    currentOrder = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        address: address,
        deliveryTime: document.getElementById('deliveryTime').value,
        items: cart,
        deliveryFee: deliveryFee,
        total: (cart.reduce((sum, item) => sum + item.price * (item.quantity || 1), 0) + deliveryFee).toFixed(2),
        date: new Date().toISOString()
    };
    showPaymentForm();
});

document.getElementById('paymentForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const lang = document.getElementById('languageSelect').value;

    // Xato xabarlarini tozalash
    document.getElementById('cardNumberError').classList.add('hidden');
    document.getElementById('expiryDateError').classList.add('hidden');
    document.getElementById('cvvError').classList.add('hidden');

    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;

    let hasError = false;

    if (!/^\d{16}$/.test(cardNumber)) {
        document.getElementById('cardNumberError').textContent = translations[lang].cardNumber + ' 16 raqamdan iborat bo‘lishi kerak!';
        document.getElementById('cardNumberError').classList.remove('hidden');
        hasError = true;
    }
    if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiryDate)) {
        document.getElementById('expiryDateError').textContent = translations[lang].expiryDate + ' MM/YY formatida bo‘lishi kerak!';
        document.getElementById('expiryDateError').classList.remove('hidden');
        hasError = true;
    }
    if (!/^\d{3,4}$/.test(cvv)) {
        document.getElementById('cvvError').textContent = translations[lang].cvv + ' 3 yoki 4 raqamdan iborat bo‘lishi kerak!';
        document.getElementById('cvvError').classList.remove('hidden');
        hasError = true;
    }

    if (hasError) return;

    if (!currentOrder) {
        alert(translations[lang].cartEmpty || 'Buyurtma topilmadi!');
        return;
    }

    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    orders.push({ ...currentOrder, status: 'Tayyorlanmoqda' });
    localStorage.setItem('orders', JSON.stringify(orders));
    alert(translations[lang].paymentSuccess);
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));
    togglePayment();
    updateCart();

    markerLayer.clearLayers();
    map.setView([41.2995, 69.2401], 13);
    L.marker([41.2995, 69.2401]).addTo(markerLayer)
        .bindPopup(`${currentOrder.address}`)
        .openPopup();
    currentOrder = null;
});

function filterMenu(category) {
    const priceFilter = document.getElementById('priceFilter').value;
    displayMenu(category, priceFilter);
}

function filterByPrice() {
    const category = document.querySelector('#menu button.bg-gray-300')?.textContent.toLowerCase() || 'all';
    const priceFilter = document.getElementById('priceFilter').value;
    displayMenu(category, priceFilter);
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    const themeIcon = document.getElementById('themeIcon');
    themeIcon.innerHTML = isDark
        ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />`
        : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
}

const swiper = new Swiper('.swiper', {
    loop: true,
    autoplay: {
        delay: 5000,
        disableOnInteraction: false,
    },
    pagination: {
        el: '.swiper-pagination',
        clickable: true,
    },
    navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
    },
});

const savedLang = localStorage.getItem('language') || 'en';
document.getElementById('languageSelect').value = savedLang;
setLanguage(savedLang);
if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();
updateCart();
updateSavedOrders();
displayMenu();
document.getElementById('savedOrdersList').parentElement.parentElement.querySelector('h3').insertAdjacentHTML('afterend', `<button onclick="toggleSavedOrders()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 gradient-btn" data-i18n="viewSavedOrders">View Saved Orders</button>`);
// paymentForm submit hodisasini o‘zgartirish
document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const lang = document.getElementById('languageSelect').value;

    // Xato xabarlarini tozalash
    document.getElementById('cardNumberError').classList.add('hidden');
    document.getElementById('expiryDateError').classList.add('hidden');
    document.getElementById('cvvError').classList.add('hidden');

    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;

    let hasError = false;

    if (!/^\d{16}$/.test(cardNumber)) {
        document.getElementById('cardNumberError').textContent = translations[lang].cardNumber + ' 16 raqamdan iborat bo‘lishi kerak!';
        document.getElementById('cardNumberError').classList.remove('hidden');
        hasError = true;
    }
    if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiryDate)) {
        document.getElementById('expiryDateError').textContent = translations[lang].expiryDate + ' MM/YY formatida bo‘lishi kerak!';
        document.getElementById('expiryDateError').classList.remove('hidden');
        hasError = true;
    }
    if (!/^\d{3,4}$/.test(cvv)) {
        document.getElementById('cvvError').textContent = translations[lang].cvv + ' 3 yoki 4 raqamdan iborat bo‘lishi kerak!';
        document.getElementById('cvvError').classList.remove('hidden');
        hasError = true;
    }

    if (hasError) return;

    if (!currentOrder) {
        alert(translations[lang].cartEmpty || 'Buyurtma topilmadi!');
        return;
    }

    // Payme sinov integratsiyasi (haqiqiy API kaliti bilan almashtirish kerak)
    const paymentData = {
        amount: currentOrder.total,
        account: { card: { pan: cardNumber, expire: expiryDate, cvv: cvv } },
        // Sinov uchun hardcoded qiymatlar
        merchant: 'test_merchant',
        terminal: 'test_terminal',
        key: 'test_key'
    };

    try {
        // Haqiqiy API so‘rovi o‘rniga sinov javobi
        const response = await fetch('https://api.paycom.uz/api/v2/payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paymentData)
        });
        const result = await response.json();

        if (result.result.code === 0) {
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push({ ...currentOrder, status: 'Tayyorlanmoqda', transactionId: result.transactionId });
            localStorage.setItem('orders', JSON.stringify(orders));
            alert(translations[lang].paymentSuccess);
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            togglePayment();
            updateCart();
            markerLayer.clearLayers();
            map.setView([41.2995, 69.2401], 13);
            L.marker([41.2995, 69.2401]).addTo(markerLayer)
                .bindPopup(`${currentOrder.address}`)
                .openPopup();
            currentOrder = null;
        } else {
            alert('To‘lov muvaffaqiyatsiz: ' + result.result.message);
        }
    } catch (error) {
        alert('To‘lov xatosi: ' + error.message);
    }
});
// Firebase konfiguratsiyasi (o‘z kalitingizni qo‘shing)
const firebaseConfig = {
    apiKey: "your-api-key",
    authDomain: "your-auth-domain",
    projectId: "your-project-id",
    storageBucket: "your-storage-bucket",
    messagingSenderId: "your-messaging-sender-id",
    appId: "your-app-id"
};

auth.onAuthStateChanged(user => {
    if (user) {
        console.log("Foydalanuvchi tizimga kirdi:", user.uid);
    } else {
        console.log("Foydalanuvchi tizimdan chiqdi");
    }
});


// Buyurtmalarni Firestore ga saqlash
document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    // ... oldingi kod ...
    if (!hasError && currentOrder) {
        const user = auth.currentUser;
        if (user) {
            await db.collection('orders').doc(user.uid).collection('userOrders').add({
                ...currentOrder,
                userId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        // ... qolgan kod ...
    }
});